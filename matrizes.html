<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrizes de Refer√™ncia - SADE v0.3.0</title>
    <meta name="description" content="An√°lise de correla√ß√£o entre quest√µes e habilidades das Matrizes de Refer√™ncia - SADE v0.3.0">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        :root {
            --purple: #7c3aed;
            --purple-dark: #6d28d9;
            --purple-light: rgba(124, 58, 237, 0.1);
            --green: #22c55e;
            --orange: #f59e0b;
            --red: #ef4444;
        }
        
        .sade-header {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: white;
            padding: 2rem 0;
        }
        
        .btn-purple {
            background-color: var(--purple);
            border-color: var(--purple);
            color: white;
        }
        
        .btn-purple:hover {
            background-color: var(--purple-dark);
            border-color: var(--purple-dark);
            color: white;
        }
        
        .btn-outline-purple {
            border: 2px solid var(--purple);
            color: var(--purple);
            background: transparent;
        }
        
        .btn-outline-purple:hover {
            background-color: var(--purple);
            border-color: var(--purple);
            color: white;
        }
        
        .upload-area {
            border: 3px dashed var(--purple);
            border-radius: 15px;
            background: var(--purple-light);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: rgba(124, 58, 237, 0.15);
            transform: scale(1.02);
        }
        
        .upload-area.dragover {
            background: rgba(124, 58, 237, 0.2);
            border-color: var(--purple-dark);
        }
        
        .file-preview {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .analysis-results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .correlation-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        .correlation-high { 
            background-color: var(--green); 
            color: white; 
        }
        .correlation-medium { 
            background-color: var(--orange); 
            color: white; 
        }
        .correlation-low { 
            background-color: var(--red); 
            color: white; 
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--purple);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 3rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .habilidade-details {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
        
        .correlation-score {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .table th {
            background-color: var(--purple);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .table tbody tr:hover {
            background-color: rgba(124, 58, 237, 0.05);
        }
        
        .keyword-match {
            background-color: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <header class="sade-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-2 text-center mb-3 mb-lg-0">
                    <img src="assets/logo.png" alt="Bras√£o de Ararend√°" class="img-fluid" style="max-height: 80px;" onerror="this.src='assets/logo-arara.svg'">
                </div>
                <div class="col-lg-8 text-center">
                    <h1 class="display-5 fw-bold mb-1">SADE - Matrizes de Refer√™ncia</h1>
                    <p class="lead mb-0">Sistema de An√°lise de Correla√ß√£o Quest√µes x Habilidades</p>
                    <div class="mt-2">
                        <span class="badge bg-success fs-6 rounded-pill">
                            <i class="fas fa-brain me-1"></i>AN√ÅLISE INTELIGENTE
                        </span>
                        <small class="text-muted ms-2">Correla√ß√£o baseada em palavras-chave e contexto</small>
                    </div>
                </div>
                <div class="col-lg-2 text-center">
                    <span class="badge bg-warning text-dark fs-6 rounded-pill">v0.3.0</span>
                    <br><small class="opacity-75">MATRIZ COMPLETA</small>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">‚Üê Voltar ao SADE</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Upload Section -->
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card border-0 shadow">
                    <div class="card-header bg-purple text-white">
                        <h4 class="mb-0"><i class="fas fa-upload me-2"></i>An√°lise de Prova - Matriz de Refer√™ncia Completa</h4>
                    </div>
                    <div class="card-body p-4">
                        <!-- Form -->
                        <form id="analysisForm">
                            <!-- Basic Info -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-graduation-cap me-1"></i>Ano Escolar
                                    </label>
                                    <select id="anoEscolar" class="form-select" required>
                                        <option value="">Selecione</option>
                                        <option value="6">6¬∫ ano</option>
                                        <option value="7">7¬∫ ano</option>
                                        <option value="8">8¬∫ ano</option>
                                        <option value="9">9¬∫ ano</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-book me-1"></i>Disciplina
                                    </label>
                                    <select id="disciplina" class="form-select" required>
                                        <option value="">Selecione</option>
                                        <option value="portugues_leitura">Portugu√™s - Leitura</option>
                                        <option value="portugues_escrita">Portugu√™s - Escrita</option>
                                        <option value="matematica">Matem√°tica</option>
                                        <option value="ciencias">Ci√™ncias da Natureza</option>
                                    </select>
                                </div>
                            </div>

                            <!-- File Upload -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-file me-1"></i>Arquivo da Prova
                                </label>
                                
                                <!-- Upload Area -->
                                <div class="upload-area" id="uploadArea" style="cursor: pointer;">
                                    <i class="fas fa-file-pdf fa-4x text-purple mb-3"></i>
                                    <h5 class="text-purple mb-3">üìÑ An√°lise Especializada de PDF</h5>
                                    <p class="text-muted mb-3">Formato aceito: apenas PDF (m√°x. 15MB)</p>
                                    <p class="text-sm text-muted">Sistema avan√ßado com PDF.js para m√°xima precis√£o</p>
                                    
                                    <input type="file" id="fileInput" accept=".pdf,.txt" style="position: absolute; opacity: 0; width: 1px; height: 1px; overflow: hidden;">
                                    
                                    <div class="d-flex justify-content-center gap-2">
                                        <button type="button" class="btn btn-purple mb-0" style="cursor: pointer; z-index: 10;" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(function() { document.getElementById('fileInput').click(); }, 0);">
                                            <i class="fas fa-folder-open me-2"></i>Escolher Arquivo
                                        </button>
                                        <button type="button" class="btn btn-outline-purple" onclick="clearFile(); event.stopPropagation();">
                                            <i class="fas fa-times me-2"></i>Limpar
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File Preview -->
                                <div id="filePreview" class="file-preview mt-3" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-alt fa-2x text-success me-3"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1" id="fileName">arquivo.txt</h6>
                                            <small class="text-muted" id="fileInfo">1.2 KB ‚Ä¢ text/plain</small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-purple btn-lg" id="analyzeBtn">
                                    <i class="fas fa-search me-2"></i>Analisar Correla√ß√µes
                                </button>
                                
                                <div class="row g-2">
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" onclick="testeRapido()">
                                            <i class="fas fa-play me-2"></i>Teste R√°pido
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-info w-100" onclick="verificarMatriz()">
                                            <i class="fas fa-database me-2"></i>Ver Matriz
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="mostrarDemo()">
                                            <i class="fas fa-info me-2"></i>Como Usar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Stats Cards -->
            <div class="row mt-4">
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-list-ol fa-2x text-purple mb-2"></i>
                        <h4 id="totalQuestoes" class="text-purple">0</h4>
                        <small class="text-muted">Quest√µes Analisadas</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-bullseye fa-2x text-success mb-2"></i>
                        <h4 id="correlacionesEncontradas" class="text-success">0</h4>
                        <small class="text-muted">Correla√ß√µes Encontradas</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                        <h4 id="mediaCorrelacao" class="text-warning">0%</h4>
                        <small class="text-muted">Precis√£o M√©dia</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-graduation-cap fa-2x text-info mb-2"></i>
                        <h4 id="habilidadesCobertas" class="text-info">0</h4>
                        <small class="text-muted">Habilidades Cobertas</small>
                    </div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div class="analysis-results">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-chart-bar me-2"></i>Resultados da An√°lise</h4>
                    <div>
                        <button class="btn btn-outline-success btn-sm me-2" onclick="exportarResultados()">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="mostrarDetalhes()">
                            <i class="fas fa-eye me-1"></i>Detalhes
                        </button>
                    </div>
                </div>
                
                <!-- Correlations Table -->
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th width="8%">Quest√£o</th>
                                <th width="12%">C√≥digo</th>
                                <th width="35%">Habilidade</th>
                                <th width="15%">BNCC</th>
                                <th width="15%">Correla√ß√£o</th>
                                <th width="15%">Palavras-chave</th>
                            </tr>
                        </thead>
                        <tbody id="correlationsTable">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-purple mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="loadingTitle">Processando...</h5>
            <p class="text-muted mb-0" id="loadingMessage">Aguarde um momento</p>
            <div class="progress mt-3" style="height: 8px;">
                <div id="progressBar" class="progress-bar bg-purple" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PDF.js Library for enhanced PDF reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script src="matriz-referencia-dados.js"></script>
    <script src="verificar-matriz.js"></script>
    
    <script>
        // Global variables
        let selectedFile = null;
        let analysisResults = null;
        
        // Polyfill para garantir que o m√©todo click() funcione em todos os navegadores
        (function() {
            if (!HTMLElement.prototype._click) {
                HTMLElement.prototype._click = HTMLElement.prototype.click;
            }
            
            HTMLElement.prototype.click = function() {
                try {
                    this._click();
                } catch (e) {
                    console.log('Usando m√©todo alternativo para click');
                    // Criar e disparar um evento de clique manualmente
                    var clickEvent = document.createEvent('MouseEvents');
                    clickEvent.initEvent('click', true, true);
                    this.dispatchEvent(clickEvent);
                }
            };
        })();
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ SADE Matrizes v0.3.1 - Sistema Especializado em PDF');
            
            try {
                // Verificar se estat√≠sticas est√£o carregadas
                if (typeof estatisticasMatriz !== 'undefined') {
                    console.log('üìä Estat√≠sticas da Matriz:', estatisticasMatriz);
                } else {
                    console.warn('‚ö†Ô∏è Estat√≠sticas da matriz n√£o carregadas');
                }
                
                // Configurar PDF.js globalmente
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    console.log('‚úÖ PDF.js configurado com sucesso');
                } else {
                    console.warn('‚ö†Ô∏è PDF.js n√£o carregado');
                }
                
                // Configurar event listeners
                configurarEventListeners();
                console.log('‚úÖ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                alert('Erro na inicializa√ß√£o do sistema. Verifique o console para detalhes.');
            }
        });
        
        // Configure event listeners
        function configurarEventListeners() {
            try {
                console.log('üîß Configurando event listeners...');
                
                // Verificar se elementos existem
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');
                const analysisForm = document.getElementById('analysisForm');
                
                if (!fileInput) {
                    console.error('‚ùå Elemento fileInput n√£o encontrado');
                    return;
                }
                if (!uploadArea) {
                    console.error('‚ùå Elemento uploadArea n√£o encontrado');
                    return;
                }
                if (!analysisForm) {
                    console.error('‚ùå Elemento analysisForm n√£o encontrado');
                    return;
                }
                
                // File input change
                fileInput.addEventListener('change', handleFileSelect);
                // Adicionar evento de clique diretamente no input
                fileInput.addEventListener('click', function(e) {
                    console.log('üñ±Ô∏è Clique direto no input de arquivo');
                });
                console.log('‚úÖ Event listener para fileInput configurado');
                
                // Drag and drop
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('dragleave', handleDragLeave);
                uploadArea.addEventListener('drop', handleDrop);
                uploadArea.addEventListener('click', function(e) {
                    console.log('üñ±Ô∏è Click na √°rea de upload', e.target);
                    // Verificar se o clique foi em algum bot√£o
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        // N√£o fazer nada, deixar os bot√µes funcionarem normalmente
                        console.log('üñ±Ô∏è Clique em bot√£o, ignorando');
                        return;
                    }
                    // Para qualquer outro clique na √°rea de upload, abrir o seletor de arquivo
                    console.log('üñ±Ô∏è Clique na √°rea de upload, abrindo seletor');
                    e.preventDefault();
                    e.stopPropagation();
                    // Usar setTimeout para garantir que o evento de clique seja processado completamente
                    setTimeout(function() {
                        selectFile();
                    }, 10);
                });
                console.log('‚úÖ Event listeners para upload area configurados');
                
                // Form submission
                analysisForm.addEventListener('submit', handleFormSubmit);
                console.log('‚úÖ Event listener para form configurado');
                
                console.log('‚úÖ Todos os event listeners configurados com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao configurar event listeners:', error);
            }
        }
        
        // File selection function - Simple and clean
        function selectFile() {
            console.log('üîç Abrindo seletor de arquivo...');
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                try {
                    // Usar setTimeout para evitar problemas com eventos de clique
                    setTimeout(function() {
                        fileInput.click();
                        console.log('‚úÖ Di√°logo de sele√ß√£o de arquivo aberto');
                    }, 0);
                } catch (error) {
                    console.error('‚ùå Erro ao abrir di√°logo de sele√ß√£o de arquivo:', error);
                    alert('Erro ao abrir seletor de arquivo. Por favor, tente novamente ou use arrastar e soltar.');
                }
            } else {
                console.error('‚ùå Elemento fileInput n√£o encontrado');
                alert('Erro: Elemento de input de arquivo n√£o encontrado.');
            }
        }
        
        // Alternative function for direct file selection
        function abrirSeletorArquivo() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                try {
                    // Usar setTimeout para evitar problemas com eventos de clique
                    setTimeout(function() {
                        fileInput.click();
                        console.log('‚úÖ Di√°logo de sele√ß√£o de arquivo aberto via abrirSeletorArquivo');
                    }, 0);
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao abrir di√°logo de sele√ß√£o de arquivo via abrirSeletorArquivo:', error);
                    alert('Erro ao abrir seletor de arquivo. Por favor, tente novamente ou use arrastar e soltar.');
                    return false;
                }
            }
            console.error('‚ùå Elemento fileInput n√£o encontrado em abrirSeletorArquivo');
            alert('Erro: Elemento de input de arquivo n√£o encontrado.');
            return false;
        }
        
        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // Verificar se √© PDF
                if (file.type !== 'application/pdf') {
                    alert('‚ùå Apenas arquivos PDF s√£o aceitos! Por favor, selecione um arquivo PDF.');
                    return;
                }
                
                // Verificar tamanho (15MB para PDF)
                if (file.size > 15 * 1024 * 1024) {
                    alert('‚ùå Arquivo muito grande! M√°ximo 15MB para PDF.');
                    return;
                }
                
                selectedFile = file;
                showFilePreview(file);
            }
        }
        
        function showFilePreview(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').textContent = 
                (file.size / 1024).toFixed(1) + ' KB ‚Ä¢ ' + (file.type || 'Tipo desconhecido');
            document.getElementById('filePreview').style.display = 'block';
        }
        
        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                
                // Verificar se √© PDF
                if (file.type !== 'application/pdf') {
                    alert('‚ùå Apenas arquivos PDF s√£o aceitos! Por favor, selecione um arquivo PDF.');
                    return;
                }
                
                // Verificar tamanho
                if (file.size <= 15 * 1024 * 1024) {
                    selectedFile = file;
                    showFilePreview(file);
                    document.getElementById('fileInput').files = files;
                } else {
                    alert('‚ùå Arquivo muito grande! M√°ximo 15MB para PDF.');
                }
            }
        }
        
        // Form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const ano = document.getElementById('anoEscolar').value;
            const disciplina = document.getElementById('disciplina').value;
            
            if (!ano || !disciplina) {
                alert('‚ö†Ô∏è Por favor, preencha o ano escolar e a disciplina.');
                return;
            }
            
            if (!selectedFile) {
                alert('‚ö†Ô∏è Por favor, selecione um arquivo.');
                return;
            }
            
            iniciarAnalise(ano, disciplina, selectedFile);
        }
        
        // Analysis functions
        async function iniciarAnalise(ano, disciplina, file) {
            console.log('üîç Iniciando an√°lise avan√ßada:', { ano, disciplina, file: file.name });
            
            mostrarLoading('Preparando an√°lise...', 'Carregando arquivo');
            atualizarProgresso(10);
            
            try {
                // Read file content
                const conteudo = await lerArquivo(file);
                atualizarProgresso(30);
                
                // Extract questions with advanced detection
                mostrarLoading('Analisando estrutura...', 'Detectando quest√µes automaticamente');
                const questoes = extrairQuestoesAvancado(conteudo);
                console.log(`üìù ${questoes.length} quest√µes detectadas`);
                atualizarProgresso(50);
                
                // Perform intelligent correlation analysis
                mostrarLoading('Correlacionando habilidades...', `Analisando ${questoes.length} quest√µes`);
                const resultados = analisarCorrelacoesInteligente(questoes, ano, disciplina);
                atualizarProgresso(80);
                
                // Show results
                mostrarLoading('Finalizando...', 'Preparando resultados');
                atualizarProgresso(100);
                
                setTimeout(() => {
                    esconderLoading();
                    mostrarResultados(resultados, ano, disciplina);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Erro na an√°lise:', error);
                esconderLoading();
                alert(`Erro na an√°lise: ${error.message}`);
            }
        }
        
        // Enhanced PDF reading function using PDF.js
        function lerArquivo(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('üìñ Iniciando leitura avan√ßada de PDF...');
                    
                    if (file.type === 'application/pdf') {
                        // Usar PDF.js para extra√ß√£o robusta
                        const texto = await lerPDFAvancado(file);
                        resolve(texto);
                    } else {
                        reject(new Error('Apenas arquivos PDF s√£o suportados'));
                    }
                } catch (error) {
                    console.error('‚ùå Erro na leitura:', error);
                    reject(error);
                }
            });
        }
        
        // Advanced PDF reading using PDF.js
        async function lerPDFAvancado(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                
                fileReader.onload = async function() {
                    try {
                        console.log('üîß Configurando PDF.js...');
                        
                        // Configurar PDF.js
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        
                        // Carregar PDF
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        
                        console.log(`üìÑ PDF carregado: ${pdf.numPages} p√°ginas`);
                        
                        let textoCompleto = '';
                        const totalPaginas = pdf.numPages;
                        
                        // Extrair texto de cada p√°gina
                        for (let numeroPagina = 1; numeroPagina <= totalPaginas; numeroPagina++) {
                            try {
                                console.log(`üìë Processando p√°gina ${numeroPagina}/${totalPaginas}...`);
                                
                                const pagina = await pdf.getPage(numeroPagina);
                                const conteudoTexto = await pagina.getTextContent();
                                
                                // Extrair texto com posicionamento
                                let textoPagina = '';
                                let linhaAtual = '';
                                let yAnterior = null;
                                
                                // Organizar itens por posi√ß√£o Y (altura)
                                const itensOrdenados = conteudoTexto.items.sort((a, b) => {
                                    if (Math.abs(a.transform[5] - b.transform[5]) < 2) {
                                        return a.transform[4] - b.transform[4]; // ordenar por X se Y similar
                                    }
                                    return b.transform[5] - a.transform[5]; // ordenar por Y (de cima para baixo)
                                });
                                
                                for (const item of itensOrdenados) {
                                    const y = Math.round(item.transform[5]);
                                    
                                    // Detectar nova linha
                                    if (yAnterior !== null && Math.abs(y - yAnterior) > 2) {
                                        if (linhaAtual.trim()) {
                                            textoPagina += linhaAtual.trim() + '\n';
                                        }
                                        linhaAtual = '';
                                    }
                                    
                                    // Adicionar texto do item
                                    if (item.str && item.str.trim()) {
                                        linhaAtual += item.str + ' ';
                                    }
                                    
                                    yAnterior = y;
                                }
                                
                                // Adicionar √∫ltima linha
                                if (linhaAtual.trim()) {
                                    textoPagina += linhaAtual.trim() + '\n';
                                }
                                
                                // Adicionar separador de p√°gina
                                if (textoPagina.trim()) {
                                    textoCompleto += `\n--- P√ÅGINA ${numeroPagina} ---\n`;
                                    textoCompleto += textoPagina;
                                    textoCompleto += '\n';
                                }
                                
                            } catch (erroPagina) {
                                console.warn(`‚ö†Ô∏è Erro na p√°gina ${numeroPagina}:`, erroPagina);
                                textoCompleto += `\n[ERRO NA P√ÅGINA ${numeroPagina}]\n`;
                            }
                        }
                        
                        // Limpar e otimizar texto
                        textoCompleto = limparTextoExtraido(textoCompleto);
                        
                        console.log(`‚úÖ PDF processado: ${textoCompleto.length} caracteres extra√≠dos`);
                        
                        if (textoCompleto.length < 50) {
                            reject(new Error('PDF parece estar vazio ou com pouco texto. Verifique se o arquivo n√£o est√° protegido ou corrompido.'));
                        } else {
                            resolve(textoCompleto);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro no processamento PDF:', error);
                        reject(new Error(`Erro ao processar PDF: ${error.message}`));
                    }
                };
                
                fileReader.onerror = () => {
                    reject(new Error('Erro ao ler arquivo PDF'));
                };
                
                // Ler como ArrayBuffer para PDF.js
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        // Function to clean extracted text
        function limparTextoExtraido(texto) {
            return texto
                // Remover m√∫ltiplas quebras de linha
                .replace(/\n{3,}/g, '\n\n')
                // Remover espa√ßos m√∫ltiplos
                .replace(/[ \t]{2,}/g, ' ')
                // Remover linhas vazias excessivas
                .replace(/^\s*\n/gm, '')
                // Normalizar separadores de p√°gina
                .replace(/--- P√ÅGINA \d+ ---/g, (match) => '\n' + match + '\n')
                // Trim final
                .trim();
        }
        
        // Enhanced question extraction function optimized for PDF
        function extrairQuestoesAvancado(conteudo) {
            const questoes = [];
            let textoLimpo = conteudo.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Limpar texto especificamente extra√≠do de PDF
            textoLimpo = limparTextoParaDeteccao(textoLimpo);
            
            console.log('üîç Iniciando detec√ß√£o avan√ßada de quest√µes em PDF...');
            
            // Padr√µes otimizados para texto extra√≠do de PDF
            const padroes = [
                // Padr√£o 1: N√∫mero seguido de ) ou . com texto (mais flex√≠vel)
                /(?:^|\n)\s*(\d+)\s*[).]\s*([^\n]+(?:\n(?!\s*\d+\s*[).])[^\n]*)*)/g,
                
                // Padr√£o 2: "Quest√£o" seguido de n√∫mero (case insensitive)
                /(?:^|\n)\s*(?:quest√£o|QUEST√ÉO|Quest√£o)\s*(\d+)[\s\-.:)]*([^\n]+(?:\n(?!\s*(?:quest√£o|QUEST√ÉO|Quest√£o)\s*\d+)[^\n]*)*)/gi,
                
                // Padr√£o 3: N√∫mero em nova linha seguido de texto
                /(?:^|\n)\s*(\d+)\s*\n\s*([^\n]+(?:\n(?!\s*\d+\s*\n)[^\n]*)*)/g,
                
                // Padr√£o 4: Par√™nteses com n√∫mero
                /(?:^|\n)\s*\((\d+)\)\s*([^\n]+(?:\n(?!\s*\(\d+\))[^\n]*)*)/g,
                
                // Padr√£o 5: N√∫mero isolado seguido de texto (PDF extraction)
                /(?:^|\n)(\d+)\s+([A-Za-z√Ä-√∫][^\n]+(?:\n(?!\d+\s+[A-Za-z√Ä-√∫])[^\n]*)*)/g,
                
                // Padr√£o 6: Formato espec√≠fico para provas (ex: "01.", "02.")
                /(?:^|\n)\s*(\d{2,})\s*[.\-)\s]+([^\n]+(?:\n(?!\s*\d{2,}\s*[.\-)\s])[^\n]*)*)/g
            ];
            
            let melhorResultado = [];
            let melhorPadrao = 0;
            let melhorScore = 0;
            
            // Testa cada padr√£o e escolhe o melhor baseado na qualidade das quest√µes
            padroes.forEach((padrao, index) => {
                const matches = [...textoLimpo.matchAll(padrao)];
                console.log(`Padr√£o ${index + 1}: ${matches.length} quest√µes encontradas`);
                
                if (matches.length > 0) {
                    // Calcular score baseado na quantidade e qualidade
                    let score = matches.length;
                    
                    // B√¥nus se as quest√µes t√™m numera√ß√£o sequencial
                    const numeros = matches.map(m => parseInt(m[1])).sort((a, b) => a - b);
                    const sequencial = numeros.every((num, i) => i === 0 || num === numeros[i-1] + 1);
                    if (sequencial) score += 10;
                    
                    // B√¥nus se as quest√µes t√™m tamanho adequado
                    const tamanhosAdequados = matches.filter(m => m[2] && m[2].trim().length > 20 && m[2].trim().length < 2000);
                    score += tamanhosAdequados.length;
                    
                    // B√¥nus se come√ßam do n√∫mero 1
                    if (numeros[0] === 1) score += 5;
                    
                    console.log(`Score do padr√£o ${index + 1}: ${score}`);
                    
                    if (score > melhorScore) {
                        melhorResultado = matches;
                        melhorPadrao = index + 1;
                        melhorScore = score;
                    }
                }
            });
            
            console.log(`‚úÖ Melhor padr√£o: ${melhorPadrao} com ${melhorResultado.length} quest√µes`);
            
            // Processar quest√µes encontradas
            melhorResultado.forEach((match, index) => {
                const numero = parseInt(match[1]);
                let textoQuestao = match[2] ? match[2].trim() : '';
                
                // Limpar texto da quest√£o
                textoQuestao = limparTextoQuestao(textoQuestao);
                
                // Validar quest√£o
                if (textoQuestao.length >= 10 && textoQuestao.length <= 3000) {
                    // Extrair palavras-chave avan√ßadas
                    const palavrasChaveAvancadas = extrairPalavrasChaveAvancadas(textoQuestao);
                    
                    // Detectar categoria da quest√£o
                    const categoria = detectarCategoria(textoQuestao);
                    
                    // Analisar contexto pedag√≥gico
                    const contextoPedagogico = analisarContextoPedagogico(textoQuestao);
                    
                    questoes.push({
                        numero: numero,
                        texto: textoQuestao,
                        posicao: index + 1,
                        origem: `Padr√£o ${melhorPadrao}`,
                        palavrasChaveAvancadas: palavrasChaveAvancadas,
                        categoria: categoria,
                        contextoPedagogico: contextoPedagogico
                    });
                } else {
                    console.warn(`‚ùå Quest√£o ${numero} descartada (tamanho: ${textoQuestao.length})`);
                }
            });
            
            // An√°lise adicional se poucas quest√µes foram encontradas
            if (questoes.length < 3) {
                console.log('üîÑ Tentando an√°lise alternativa...');
                const questoesAlternativas = tentarDeteccaoAlternativa(textoLimpo);
                if (questoesAlternativas.length > questoes.length) {
                    questoes.splice(0, questoes.length, ...questoesAlternativas);
                }
            }
            
            console.log(`üìä Total de quest√µes extra√≠das: ${questoes.length}`);
            return questoes;
        }
        
        // Function to clean text for better question detection
        function limparTextoParaDeteccao(texto) {
            return texto
                // Remover separadores de p√°gina
                .replace(/--- P√ÅGINA \d+ ---/g, '\n')
                // Remover headers e footers comuns
                .replace(/^.*p√°gina.*\d+.*$/gmi, '')
                .replace(/^.*total.*\d+.*$/gmi, '')
                // Normalizar espa√ßos e quebras
                .replace(/\s+/g, ' ')
                .replace(/\n\s*\n/g, '\n')
                // Remover caracteres especiais de PDF
                .replace(/[^\w\s\n\r.!?()[\]{},;:\-"'√°√©√≠√≥√∫√†√®√¨√≤√π√¢√™√Æ√¥√ª√£√µ√ß√Å√â√ç√ì√ö√Ä√à√å√í√ô√Ç√ä√é√î√õ√É√ï√á]/g, ' ')
                .trim();
        }
        
        // Function to clean individual question text
        function limparTextoQuestao(texto) {
            return texto
                .replace(/\s+/g, ' ')
                .replace(/^\s*[\-\*‚Ä¢]\s*/, '')
                .replace(/\n{2,}/g, '\n')
                .trim();
        }
        
        // Alternative detection for difficult cases
        function tentarDeteccaoAlternativa(texto) {
            console.log('üîç Tentando detec√ß√£o alternativa...');
            
            const questoes = [];
            const linhas = texto.split('\n');
            let questaoAtual = null;
            let textoAtual = '';
            
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i].trim();
                
                // Detectar in√≠cio de quest√£o por palavras-chave
                const inicioQuestao = /^(\d+)[\s\-\.]*(?:quest√£o|pergunta|item|letra)?[\s\-:]*(.*)$/i.exec(linha);
                
                if (inicioQuestao) {
                    // Salvar quest√£o anterior se existir
                    if (questaoAtual && textoAtual.trim()) {
                        // Extrair palavras-chave avan√ßadas
                        const palavrasChaveAvancadas = extrairPalavrasChaveAvancadas(textoAtual.trim());
                        
                        // Detectar categoria da quest√£o
                        const categoria = detectarCategoria(textoAtual.trim());
                        
                        // Analisar contexto pedag√≥gico
                        const contextoPedagogico = analisarContextoPedagogico(textoAtual.trim());
                        
                        questoes.push({
                            numero: questaoAtual,
                            texto: textoAtual.trim(),
                            posicao: questoes.length + 1,
                            origem: 'Detec√ß√£o alternativa',
                            palavrasChaveAvancadas: palavrasChaveAvancadas,
                            categoria: categoria,
                            contextoPedagogico: contextoPedagogico
                        });
                    }
                    
                    // Iniciar nova quest√£o
                    questaoAtual = parseInt(inicioQuestao[1]);
                    textoAtual = inicioQuestao[2] || '';
                } else if (questaoAtual && linha) {
                    // Continuar quest√£o atual
                    textoAtual += (textoAtual ? ' ' : '') + linha;
                }
            }
            
            // Adicionar √∫ltima quest√£o
            if (questaoAtual && textoAtual.trim()) {
                // Extrair palavras-chave avan√ßadas
                const palavrasChaveAvancadas = extrairPalavrasChaveAvancadas(textoAtual.trim());
                
                // Detectar categoria da quest√£o
                const categoria = detectarCategoria(textoAtual.trim());
                
                // Analisar contexto pedag√≥gico
                const contextoPedagogico = analisarContextoPedagogico(textoAtual.trim());
                
                questoes.push({
                    numero: questaoAtual,
                    texto: textoAtual.trim(),
                    posicao: questoes.length + 1,
                    origem: 'Detec√ß√£o alternativa',
                    palavrasChaveAvancadas: palavrasChaveAvancadas,
                    categoria: categoria,
                    contextoPedagogico: contextoPedagogico
                });
            }
            
            console.log(`üìã Detec√ß√£o alternativa encontrou: ${questoes.length} quest√µes`);
            return questoes.filter(q => q.texto.length >= 10);
        }
        
        // Detecta categoria da quest√£o baseada no conte√∫do
        function detectarCategoria(texto) {
            const textoLower = texto.toLowerCase();
            
            if (textoLower.match(/calcul|matem√°tica|n√∫mero|opera√ß√£o|soma|subtra√ß√£o|multiplica√ß√£o|divis√£o|fra√ß√£o|porcentagem|equa√ß√£o|gr√°fico|√°rea|volume|geometria/)) {
                return 'matematica';
            } else if (textoLower.match(/texto|leia|interprete|autor|narrativa|personagem|enredo|par√°grafo|verbo|substantivo|adjetivo|gram√°tica/)) {
                return 'portugues';
            } else if (textoLower.match(/c√©lula|√°tomo|energia|for√ßa|sistema|organismo|mat√©ria|qu√≠mica|f√≠sica|biologia|experimento/)) {
                return 'ciencias';
            } else {
                return 'geral';
            }
        }
        
        // Extra√ß√£o avan√ßada de palavras-chave otimizada para PDF
        function extrairPalavrasChaveAvancadas(texto) {
            const stopWords = new Set([
                'o', 'a', 'os', 'as', 'um', 'uma', 'uns', 'umas', 'de', 'da', 'do', 'das', 'dos',
                'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com', 'sem', 'sob', 'sobre',
                'que', 'qual', 'quais', 'como', 'quando', 'onde', 'por que', 'porque',
                'e', 'ou', 'mas', 'se', 'ent√£o', 'assim', 'tamb√©m', 'j√°', 'ainda',
                '√©', 's√£o', 'foi', 'foram', 'ser', 'estar', 'ter', 'haver',
                'este', 'esta', 'estes', 'estas', 'esse', 'essa', 'esses', 'essas',
                'aquele', 'aquela', 'aqueles', 'aquelas', 'isso', 'isto', 'aquilo',
                'texto', 'quest√£o', 'pergunta', 'resposta', 'letra', 'item', 'alternativa',
                'pode', 'podem', 'deve', 'devem', 'vai', 'v√£o', 'mais', 'menos', 'muito', 'pouco'
            ]);
            
            // Extrai substantivos, verbos e conceitos importantes
            const palavras = texto.toLowerCase()
                .replace(/[^\w\s√°√©√≠√≥√∫√†√®√¨√≤√π√¢√™√Æ√¥√ª√£√µ√ß]/g, ' ')
                .split(/\s+/)
                .filter(palavra => palavra.length > 3 && !stopWords.has(palavra));
            
            // Identifica termos compostos importantes
            const termosCompostos = [];
            const textoLower = texto.toLowerCase();
            
            const conceitosImportantes = [
                'meio ambiente', 'desenvolvimento sustent√°vel', 'recursos naturais',
                'sistema solar', 'ciclo da √°gua', 'cadeia alimentar',
                'fra√ß√£o equivalente', 'regra de tr√™s', 'porcentagem',
                'sujeito oculto', 'predicado verbal', 'figura de linguagem',
                'fun√ß√£o sint√°tica', 'processo de forma√ß√£o'
            ];
            
            conceitosImportantes.forEach(conceito => {
                if (textoLower.includes(conceito)) {
                    termosCompostos.push(conceito.replace(' ', '_'));
                }
            });
            
            return [...new Set([...palavras, ...termosCompostos])].slice(0, 15);
        }
        
        // An√°lise do contexto pedag√≥gico
        function analisarContextoPedagogico(texto) {
            const contexto = {
                habilidadesCognitivas: [],
                tipoQuestao: 'objetiva',
                complexidade: 'media'
            };
            
            const textoLower = texto.toLowerCase();
            
            // Detecta habilidades cognitivas (Taxonomia de Bloom)
            if (textoLower.match(/lembre|identifique|liste|defina|reconhe√ßa/)) {
                contexto.habilidadesCognitivas.push('lembrar');
            }
            if (textoLower.match(/explique|descreva|compare|classifique|demonstre/)) {
                contexto.habilidadesCognitivas.push('compreender');
            }
            if (textoLower.match(/aplique|calcule|resolva|utilize|implemente/)) {
                contexto.habilidadesCognitivas.push('aplicar');
            }
            if (textoLower.match(/analise|examine|investigue|relacione|diferencie/)) {
                contexto.habilidadesCognitivas.push('analisar');
            }
            if (textoLower.match(/avalie|critique|justifique|argumente|julgar/)) {
                contexto.habilidadesCognitivas.push('avaliar');
            }
            if (textoLower.match(/crie|elabore|projete|construa|produza/)) {
                contexto.habilidadesCognitivas.push('criar');
            }
            
            // Detecta tipo de quest√£o
            if (textoLower.match(/escreva|redija|elabore|comente|produza/)) {
                contexto.tipoQuestao = 'discursiva';
            }
            
            // Detecta complexidade
            const indicadoresAlta = ['analise', 'avalie', 'relacione', 'justifique', 'compare'];
            const indicadoresBaixa = ['identifique', 'liste', 'reconhe√ßa', 'defina'];
            
            if (indicadoresAlta.some(ind => textoLower.includes(ind))) {
                contexto.complexidade = 'alta';
            } else if (indicadoresBaixa.some(ind => textoLower.includes(ind))) {
                contexto.complexidade = 'baixa';
            }
            
            return contexto;
        }
        
        // Intelligent correlation analysis function using real matrix data
        function analisarCorrelacoesInteligente(questoes, ano, disciplina) {
            console.log('üß† An√°lise inteligente iniciada...');
            console.log(`üìñ Disciplina: ${disciplina}, Ano: ${ano}`);
            
            const correlacoes = [];
            const habilidades = buscarHabilidades(disciplina, ano);
            
            if (!habilidades || habilidades.length === 0) {
                console.error('‚ùå Nenhuma habilidade encontrada para', disciplina, ano);
                return {
                    totalQuestoes: questoes.length,
                    correlacoes: [],
                    precisaoMedia: 0,
                    habilidadesCobertas: 0,
                    estatisticas: {
                        correlacionadas: 0,
                        naoCorrelacionadas: questoes.length,
                        cobertura: 0
                    }
                };
            }
            
            console.log(`üìö ${habilidades.length} habilidades dispon√≠veis para an√°lise`);
            
            questoes.forEach((questao, index) => {
                atualizarProgresso(60 + (index / questoes.length) * 20);
                console.log(`üîç Analisando quest√£o ${questao.numero}: "${questao.texto.substring(0, 50)}..."`);
                
                let melhorCorrelacao = null;
                let melhorScore = 0;
                
                // Analisa cada habilidade para encontrar a melhor correla√ß√£o
                habilidades.forEach(habilidade => {
                    const score = calcularSimilaridadeInteligente(questao, habilidade, disciplina);
                    
                    if (score.total > melhorScore) {
                        melhorScore = score.total;
                        melhorCorrelacao = {
                            habilidade: habilidade,
                            score: score,
                            precisao: Math.round(score.total)
                        };
                    }
                });
                
                // S√≥ aceita correla√ß√µes com score m√≠nimo de 25 (mais rigoroso)
                if (melhorCorrelacao && melhorScore >= 25) {
                    correlacoes.push({
                        questao: questao.numero,
                        texto: questao.texto.length > 200 ? 
                               questao.texto.substring(0, 200) + '...' : 
                               questao.texto,
                        habilidade: {
                            codigo: melhorCorrelacao.habilidade.codigo,
                            descricao: melhorCorrelacao.habilidade.habilidade,
                            bncc: melhorCorrelacao.habilidade.bncc || 'N/A'
                        },
                        precisao: melhorCorrelacao.precisao,
                        palavrasChave: melhorCorrelacao.score.palavrasCorrespondentes || [],
                        detalhes: melhorCorrelacao.score.detalhes,
                        metodo: 'correlacao-inteligente'
                    });
                    
                    console.log(`‚úÖ Quest√£o ${questao.numero} correlacionada com ${melhorCorrelacao.habilidade.codigo} (${melhorCorrelacao.precisao}%)`);
                } else {
                    console.log(`‚ö†Ô∏è Quest√£o ${questao.numero} n√£o correlacionada (score m√°ximo: ${Math.round(melhorScore)})`);
                }
            });
            
            const precisaoMedia = correlacoes.length > 0 ? 
                correlacoes.reduce((sum, c) => sum + c.precisao, 0) / correlacoes.length : 0;
            
            const habilidadesUnicas = new Set(correlacoes.map(c => c.habilidade.codigo)).size;
            const cobertura = Math.round((correlacoes.length / questoes.length) * 100);
            
            console.log(`‚úÖ An√°lise conclu√≠da: ${correlacoes.length}/${questoes.length} correla√ß√µes (${cobertura}%)`);
            
            return {
                totalQuestoes: questoes.length,
                correlacoes: correlacoes,
                precisaoMedia: precisaoMedia,
                habilidadesCobertas: habilidadesUnicas,
                estatisticas: {
                    correlacionadas: correlacoes.length,
                    naoCorrelacionadas: questoes.length - correlacoes.length,
                    cobertura: cobertura
                }
            };
        }
        
        // Sistema de c√°lculo de similaridade muito mais inteligente
        function calcularSimilaridadeInteligente(questao, habilidade, disciplina) {
            let score = {
                total: 0,
                palavrasExatas: 0,
                conceitos: 0,
                contexto: 0,
                disciplinar: 0,
                pedagogico: 0,
                palavrasCorrespondentes: [],
                detalhes: {}
            };
            
            const textoQuestao = questao.texto.toLowerCase();
            const textoHabilidade = habilidade.habilidade.toLowerCase();
            const palavrasQuestao = questao.palavrasChaveAvancadas || [];
            const palavrasHabilidade = habilidade.palavras_chave || [];
            
            // 1. An√°lise de palavras-chave exatas (peso alto)
            let palavrasExatas = 0;
            palavrasQuestao.forEach(palavra => {
                if (palavrasHabilidade.includes(palavra)) {
                    palavrasExatas++;
                    score.palavrasCorrespondentes.push(palavra);
                    score.palavrasExatas += 20; // 20 pontos por palavra exata
                }
            });
            
            // 2. An√°lise de conceitos relacionados (peso m√©dio)
            const conceitosMatematica = ['n√∫mero', 'calcular', 'opera√ß√£o', 'resolver', 'problema', 'fra√ß√£o', 'decimal', 'porcentagem', 'geometria', 'medida'];
            const conceitosPortugues = ['texto', 'leitura', 'interpreta√ß√£o', 'palavra', 'sentido', 'informa√ß√£o', 'par√°grafo', 'autor', 'narrativa', 'personagem'];
            const conceitosCiencias = ['natureza', 'ambiente', '√°gua', 'terra', 'corpo', 'c√©lula', 'sistema', 'vida', 'processo', 'ciclo'];
            
            let conceitosRelevantes = [];
            if (disciplina === 'matematica') conceitosRelevantes = conceitosMatematica;
            else if (disciplina.includes('portugues')) conceitosRelevantes = conceitosPortugues;
            else if (disciplina === 'ciencias') conceitosRelevantes = conceitosCiencias;
            
            conceitosRelevantes.forEach(conceito => {
                if (textoQuestao.includes(conceito) && textoHabilidade.includes(conceito)) {
                    score.conceitos += 15; // 15 pontos por conceito relacionado
                }
            });
            
            // 3. An√°lise contextual (busca no texto completo)
            palavrasQuestao.forEach(palavra => {
                if (textoHabilidade.includes(palavra)) {
                    score.contexto += 8; // 8 pontos por palavra no contexto
                    if (!score.palavrasCorrespondentes.includes(palavra)) {
                        score.palavrasCorrespondentes.push(palavra);
                    }
                }
            });
            
            // 4. An√°lise disciplinar espec√≠fica
            if (questao.categoria === disciplina || questao.categoria === 'geral') {
                score.disciplinar += 10; // 10 pontos por categoria correta
            }
            
            // 5. An√°lise pedag√≥gica (habilidades cognitivas)
            if (questao.contextoPedagogico && questao.contextoPedagogico.habilidadesCognitivas) {
                const habilidadesCognitivas = questao.contextoPedagogico.habilidadesCognitivas;
                
                // Verifica se a habilidade da matriz corresponde ao n√≠vel cognitivo da quest√£o
                if (habilidadesCognitivas.includes('aplicar') && textoHabilidade.includes('utilizar')) {
                    score.pedagogico += 12;
                }
                if (habilidadesCognitivas.includes('analisar') && textoHabilidade.includes('analisar')) {
                    score.pedagogico += 12;
                }
                if (habilidadesCognitivas.includes('compreender') && (textoHabilidade.includes('reconhecer') || textoHabilidade.includes('identificar'))) {
                    score.pedagogico += 10;
                }
            }
            
            // 6. B√¥nus por densidade de correspond√™ncias
            if (palavrasExatas > 0) {
                const densidade = palavrasExatas / Math.max(palavrasQuestao.length, palavrasHabilidade.length);
                score.total += densidade * 25; // At√© 25 pontos de b√¥nus
            }
            
            // 7. Penaliza√ß√£o por incompatibilidade de disciplina
            if (questao.categoria !== 'geral' && questao.categoria !== disciplina && !disciplina.includes(questao.categoria)) {
                score.total -= 20; // Penaliza correla√ß√µes incorretas
            }
            
            // Calcula score total
            score.total = score.palavrasExatas + score.conceitos + score.contexto + score.disciplinar + score.pedagogico;
            score.total = Math.max(0, Math.min(100, score.total)); // Limita entre 0 e 100
            
            // Detalhes para debug
            score.detalhes = {
                palavrasExatas: score.palavrasExatas,
                conceitos: score.conceitos,
                contexto: score.contexto,
                disciplinar: score.disciplinar,
                pedagogico: score.pedagogico,
                densidade: palavrasExatas > 0 ? (palavrasExatas / Math.max(palavrasQuestao.length, palavrasHabilidade.length)) * 100 : 0
            };
            
            return score;
        }
        
        // Results display
        function mostrarResultados(resultados, ano, disciplina) {
            // Store results globally
            analysisResults = resultados;
            
            // Update stats
            document.getElementById('totalQuestoes').textContent = resultados.totalQuestoes;
            document.getElementById('correlacionesEncontradas').textContent = resultados.correlacoes.length;
            document.getElementById('mediaCorrelacao').textContent = resultados.precisaoMedia.toFixed(1) + '%';
            document.getElementById('habilidadesCobertas').textContent = resultados.habilidadesCobertas;
            
            // Update table
            const tbody = document.getElementById('correlationsTable');
            tbody.innerHTML = '';
            
            if (resultados.correlacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i><br>
                            Nenhuma correla√ß√£o encontrada com os crit√©rios de an√°lise.<br>
                            <small>Verifique se a disciplina e ano est√£o corretos.</small>
                        </td>
                    </tr>
                `;
            } else {
                resultados.correlacoes.forEach(correlacao => {
                    const precisaoClass = correlacao.precisao >= 80 ? 'correlation-high' :
                                        correlacao.precisao >= 60 ? 'correlation-medium' : 'correlation-low';
                    
                    const palavrasChaveHtml = correlacao.palavrasChave
                        .map(p => `<span class="keyword-match">${p}</span>`)
                        .join(' ');
                    
                    const row = `
                        <tr>
                            <td><strong>Q${correlacao.questao}</strong></td>
                            <td><code>${correlacao.habilidade.codigo}</code></td>
                            <td>
                                ${correlacao.habilidade.descricao}
                                <div class="habilidade-details">${correlacao.texto}</div>
                                ${correlacao.detalhes ? `
                                    <small class="text-info">
                                        <i class="fas fa-info-circle"></i> 
                                        Palavras: ${correlacao.detalhes.palavrasExatas || 0}pts, 
                                        Conceitos: ${correlacao.detalhes.conceitos || 0}pts, 
                                        Contexto: ${correlacao.detalhes.contexto || 0}pts
                                    </small>
                                ` : ''}
                            </td>
                            <td><span class="badge bg-primary">${correlacao.habilidade.bncc}</span></td>
                            <td>
                                <span class="correlation-badge ${precisaoClass}">${correlacao.precisao}%</span>
                            </td>
                            <td>
                                ${palavrasChaveHtml || '<span class="text-muted">-</span>'}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            // Log detailed results
            console.log('üìä Resultados detalhados:', {
                disciplina: disciplina,
                ano: ano,
                questoesAnalisadas: resultados.totalQuestoes,
                correlacionesEncontradas: resultados.correlacoes.length,
                cobertura: resultados.estatisticas.cobertura + '%',
                precisaoMedia: resultados.precisaoMedia.toFixed(1) + '%'
            });
        }
        
        // Utility functions
        function mostrarLoading(titulo, mensagem) {
            document.getElementById('loadingTitle').textContent = titulo;
            document.getElementById('loadingMessage').textContent = mensagem;
            document.getElementById('loadingOverlay').style.display = 'block';
        }
        
        function esconderLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function atualizarProgresso(porcentagem) {
            document.getElementById('progressBar').style.width = porcentagem + '%';
        }
        
        // Test and demo functions
        function testeRapido() {
            document.getElementById('anoEscolar').value = '6';
            document.getElementById('disciplina').value = 'portugues_leitura';
            
            // Use the real test file content
            const conteudoTeste = `1) Leia o texto abaixo e responda:

O meio ambiente √© um tema muito importante nos dias de hoje. A preserva√ß√£o da natureza depende de a√ß√µes sustent√°veis que devemos tomar para proteger nosso planeta. √â necess√°rio entender que cada pessoa tem responsabilidade sobre o futuro das pr√≥ximas gera√ß√µes.

Com base no texto, podemos afirmar que:
a) O meio ambiente n√£o √© importante
b) A preserva√ß√£o depende de a√ß√µes sustent√°veis
c) N√£o temos responsabilidade sobre o futuro
d) O planeta n√£o precisa de prote√ß√£o

2) Calcule o resultado da seguinte opera√ß√£o matem√°tica:

Se Jo√£o tem 15 laranjas e distribui igualmente entre 3 amigos, quantas laranjas cada amigo recebeu?

a) 3 laranjas
b) 4 laranjas  
c) 5 laranjas
d) 6 laranjas

3) Observe a situa√ß√£o problema:

Maria comprou 2/3 de um bolo e comeu 1/4 do que comprou. Que fra√ß√£o do bolo inteiro Maria comeu?

Para resolver este problema, precisamos:
a) Somar as fra√ß√µes 2/3 + 1/4
b) Multiplicar as fra√ß√µes 2/3 √ó 1/4
c) Dividir 2/3 por 1/4
d) Subtrair 2/3 - 1/4

4) Sobre o ciclo da √°gua, √© correto afirmar que:

A √°gua evapora dos oceanos, rios e lagos, sobe para a atmosfera formando nuvens, condensa e retorna √† Terra atrav√©s da chuva. Este processo √© fundamental para a manuten√ß√£o da vida no planeta.

a) A evapora√ß√£o n√£o faz parte do ciclo da √°gua
b) As nuvens n√£o s√£o formadas por vapor d'√°gua
c) A chuva √© o retorno da √°gua condensada √† Terra
d) O ciclo da √°gua n√£o √© importante para a vida`;
            
            const arquivo = new File([conteudoTeste], 'prova_teste.txt', { type: 'text/plain' });
            selectedFile = arquivo;
            showFilePreview(arquivo);
            
            alert('üìù Teste configurado com 4 quest√µes reais!\n\n‚úÖ Portugu√™s - Leitura, 6¬∫ ano\n‚úÖ Arquivo: prova_teste.txt\n\nClique em "Analisar Correla√ß√µes" para ver o sistema em a√ß√£o.');
        }
        
        function mostrarDemo() {
            alert(`üìñ Como usar o SADE Matrizes v0.3.0:

1Ô∏è‚É£ Selecione o ano escolar e disciplina
2Ô∏è‚É£ Configure a precis√£o m√≠nima desejada
3Ô∏è‚É£ Fa√ßa upload do arquivo da prova em PDF (Sistema otimizado para PDF)
4Ô∏è‚É£ Clique em "Analisar Correla√ß√µes"
5Ô∏è‚É£ Aguarde o processamento
6Ô∏è‚É£ Veja os resultados com correla√ß√µes e precis√£o

üîç O sistema usa an√°lise inteligente baseada em:
‚Ä¢ Palavras-chave do conte√∫do
‚Ä¢ Contexto das quest√µes
‚Ä¢ Matriz de Refer√™ncia completa
‚Ä¢ C√≥digos BNCC atualizados

‚ú® Use "Teste R√°pido" para ver um exemplo!`);
        }
        
        function verificarMatriz() {
            if (typeof matrizReferencia === 'undefined') {
                alert('‚ùå Matriz de Refer√™ncia n√£o carregada! Verifique se o arquivo matriz-referencia-dados.js est√° presente.');
                return;
            }
            
            let info = 'üìä INFORMA√á√ïES DA MATRIZ DE REFER√äNCIA\n\n';
            info += `Total de habilidades: ${estatisticasMatriz.total}\n\n`;
            info += 'üìö Por disciplina:\n';
            
            Object.entries(estatisticasMatriz.porDisciplina).forEach(([disc, total]) => {
                const disciplinaNome = {
                    'portugues_leitura': 'Portugu√™s - Leitura',
                    'portugues_escrita': 'Portugu√™s - Escrita', 
                    'matematica': 'Matem√°tica',
                    'ciencias': 'Ci√™ncias da Natureza'
                }[disc] || disc;
                
                info += `‚Ä¢ ${disciplinaNome}: ${total} habilidades\n`;
            });
            
            info += '\nüéì Por ano (Portugu√™s - Leitura):\n';
            Object.entries(matrizReferencia.portugues_leitura).forEach(([ano, habilidades]) => {
                info += `‚Ä¢ ${ano}¬∫ ano: ${habilidades.length} habilidades\n`;
            });
            
            alert(info);
        }
        
        function exportarResultados() {
            if (!analysisResults) {
                alert('Nenhum resultado para exportar.');
                return;
            }
            
            alert('üöß Funcionalidade de exporta√ß√£o ser√° implementada em breve!');
        }
        
        function mostrarDetalhes() {
            if (!analysisResults) {
                alert('Nenhum resultado para mostrar detalhes.');
                return;
            }
            
            alert('üöß Visualiza√ß√£o detalhada ser√° implementada em breve!');
        }
    </script>
</body>
</html>
