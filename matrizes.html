<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrizes de Referência - SADE v0.3.0</title>
    <meta name="description" content="Análise de correlação entre questões e habilidades das Matrizes de Referência - SADE v0.3.0">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        :root {
            --purple: #7c3aed;
            --purple-dark: #6d28d9;
            --purple-light: rgba(124, 58, 237, 0.1);
            --green: #22c55e;
            --orange: #f59e0b;
            --red: #ef4444;
        }
        
        .sade-header {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: white;
            padding: 2rem 0;
        }
        
        .btn-purple {
            background-color: var(--purple);
            border-color: var(--purple);
            color: white;
        }
        
        .btn-purple:hover {
            background-color: var(--purple-dark);
            border-color: var(--purple-dark);
            color: white;
        }
        
        .upload-area {
            border: 3px dashed var(--purple);
            border-radius: 15px;
            background: var(--purple-light);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: rgba(124, 58, 237, 0.15);
            transform: scale(1.02);
        }
        
        .upload-area.dragover {
            background: rgba(124, 58, 237, 0.2);
            border-color: var(--purple-dark);
        }
        
        .file-preview {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .analysis-results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .correlation-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        .correlation-high { 
            background-color: var(--green); 
            color: white; 
        }
        .correlation-medium { 
            background-color: var(--orange); 
            color: white; 
        }
        .correlation-low { 
            background-color: var(--red); 
            color: white; 
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--purple);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 3rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .habilidade-details {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
        
        .correlation-score {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .table th {
            background-color: var(--purple);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .table tbody tr:hover {
            background-color: rgba(124, 58, 237, 0.05);
        }
        
        .keyword-match {
            background-color: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <header class="sade-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-2 text-center mb-3 mb-lg-0">
                    <img src="assets/logo.png" alt="Brasão de Ararendá" class="img-fluid" style="max-height: 80px;" onerror="this.src='assets/logo-arara.svg'">
                </div>
                <div class="col-lg-8 text-center">
                    <h1 class="display-5 fw-bold mb-1">SADE - Matrizes de Referência</h1>
                    <p class="lead mb-0">Sistema de Análise de Correlação Questões x Habilidades</p>
                    <div class="mt-2">
                        <span class="badge bg-success fs-6 rounded-pill">
                            <i class="fas fa-brain me-1"></i>ANÁLISE INTELIGENTE
                        </span>
                        <small class="text-muted ms-2">Correlação baseada em palavras-chave e contexto</small>
                    </div>
                </div>
                <div class="col-lg-2 text-center">
                    <span class="badge bg-warning text-dark fs-6 rounded-pill">v0.3.0</span>
                    <br><small class="opacity-75">MATRIZ COMPLETA</small>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">← Voltar ao SADE</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Upload Section -->
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card border-0 shadow">
                    <div class="card-header bg-purple text-white">
                        <h4 class="mb-0"><i class="fas fa-upload me-2"></i>Análise de Prova - Matriz de Referência Completa</h4>
                    </div>
                    <div class="card-body p-4">
                        <!-- Form -->
                        <form id="analysisForm">
                            <!-- Basic Info -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-graduation-cap me-1"></i>Ano Escolar
                                    </label>
                                    <select id="anoEscolar" class="form-select" required>
                                        <option value="">Selecione</option>
                                        <option value="6">6º ano</option>
                                        <option value="7">7º ano</option>
                                        <option value="8">8º ano</option>
                                        <option value="9">9º ano</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-book me-1"></i>Disciplina
                                    </label>
                                    <select id="disciplina" class="form-select" required>
                                        <option value="">Selecione</option>
                                        <option value="portugues_leitura">Português - Leitura</option>
                                        <option value="portugues_escrita">Português - Escrita</option>
                                        <option value="matematica">Matemática</option>
                                        <option value="ciencias">Ciências da Natureza</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-school me-1"></i>Escola
                                    </label>
                                    <input type="text" id="escola" class="form-control" placeholder="Nome da escola">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-percentage me-1"></i>Precisão Mínima
                                    </label>
                                    <select id="precisaoMinima" class="form-select">
                                        <option value="30">30% - Baixa</option>
                                        <option value="50" selected>50% - Média</option>
                                        <option value="70">70% - Alta</option>
                                        <option value="85">85% - Muito Alta</option>
                                    </select>
                                </div>
                            </div>

                            <!-- File Upload -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-file me-1"></i>Arquivo da Prova
                                </label>
                                
                                <!-- Upload Area -->
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-4x text-purple mb-3"></i>
                                    <h5 class="text-purple mb-3">Selecione ou arraste o arquivo aqui</h5>
                                    <p class="text-muted mb-3">Formatos aceitos: TXT, DOC, DOCX, PDF (máx. 10MB)</p>
                                    
                                    <input type="file" id="fileInput" accept=".txt,.doc,.docx,.pdf" style="display: none;">
                                    
                                    <div class="d-flex justify-content-center gap-2">
                                        <button type="button" class="btn btn-purple" onclick="selectFile()">
                                            <i class="fas fa-folder-open me-2"></i>Escolher Arquivo
                                        </button>
                                        <button type="button" class="btn btn-outline-purple" onclick="clearFile()">
                                            <i class="fas fa-times me-2"></i>Limpar
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File Preview -->
                                <div id="filePreview" class="file-preview mt-3" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-alt fa-2x text-success me-3"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1" id="fileName">arquivo.txt</h6>
                                            <small class="text-muted" id="fileInfo">1.2 KB • text/plain</small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-purple btn-lg" id="analyzeBtn">
                                    <i class="fas fa-search me-2"></i>Analisar Correlações
                                </button>
                                
                                <div class="row g-2">
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-primary w-100" onclick="testeRapido()">
                                            <i class="fas fa-play me-2"></i>Teste Rápido
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-info w-100" onclick="verificarMatriz()">
                                            <i class="fas fa-database me-2"></i>Ver Matriz
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="mostrarDemo()">
                                            <i class="fas fa-info me-2"></i>Como Usar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Stats Cards -->
            <div class="row mt-4">
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-list-ol fa-2x text-purple mb-2"></i>
                        <h4 id="totalQuestoes" class="text-purple">0</h4>
                        <small class="text-muted">Questões Analisadas</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-bullseye fa-2x text-success mb-2"></i>
                        <h4 id="correlacionesEncontradas" class="text-success">0</h4>
                        <small class="text-muted">Correlações Encontradas</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                        <h4 id="mediaCorrelacao" class="text-warning">0%</h4>
                        <small class="text-muted">Precisão Média</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-card">
                        <i class="fas fa-graduation-cap fa-2x text-info mb-2"></i>
                        <h4 id="habilidadesCobertas" class="text-info">0</h4>
                        <small class="text-muted">Habilidades Cobertas</small>
                    </div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div class="analysis-results">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-chart-bar me-2"></i>Resultados da Análise</h4>
                    <div>
                        <button class="btn btn-outline-success btn-sm me-2" onclick="exportarResultados()">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="mostrarDetalhes()">
                            <i class="fas fa-eye me-1"></i>Detalhes
                        </button>
                    </div>
                </div>
                
                <!-- Correlations Table -->
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th width="8%">Questão</th>
                                <th width="12%">Código</th>
                                <th width="35%">Habilidade</th>
                                <th width="15%">BNCC</th>
                                <th width="15%">Correlação</th>
                                <th width="15%">Palavras-chave</th>
                            </tr>
                        </thead>
                        <tbody id="correlationsTable">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-purple mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="loadingTitle">Processando...</h5>
            <p class="text-muted mb-0" id="loadingMessage">Aguarde um momento</p>
            <div class="progress mt-3" style="height: 8px;">
                <div id="progressBar" class="progress-bar bg-purple" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="matriz-referencia-dados.js"></script>
    
    <script>
        // Global variables
        let selectedFile = null;
        let analysisResults = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 SADE Matrizes v0.3.0 - Matriz Completa carregada');
            console.log('� Estatísticas da Matriz:', estatisticasMatriz);
            configurarEventListeners();
        });
        
        // Configure event listeners
        function configurarEventListeners() {
            // File input change
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // Drag and drop
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    selectFile();
                }
            });
            
            // Form submission
            document.getElementById('analysisForm').addEventListener('submit', handleFormSubmit);
        }
        
        // File selection functions
        function selectFile() {
            document.getElementById('fileInput').click();
        }
        
        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    alert('❌ Arquivo muito grande! Máximo 10MB.');
                    return;
                }
                selectedFile = file;
                showFilePreview(file);
            }
        }
        
        function showFilePreview(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').textContent = 
                (file.size / 1024).toFixed(1) + ' KB • ' + (file.type || 'Tipo desconhecido');
            document.getElementById('filePreview').style.display = 'block';
        }
        
        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.size <= 10 * 1024 * 1024) {
                    selectedFile = file;
                    showFilePreview(file);
                    document.getElementById('fileInput').files = files;
                } else {
                    alert('❌ Arquivo muito grande! Máximo 10MB.');
                }
            }
        }
        
        // Form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const ano = document.getElementById('anoEscolar').value;
            const disciplina = document.getElementById('disciplina').value;
            const escola = document.getElementById('escola').value;
            const precisao = document.getElementById('precisaoMinima').value;
            
            if (!ano || !disciplina) {
                alert('⚠️ Por favor, preencha o ano escolar e a disciplina.');
                return;
            }
            
            if (!selectedFile) {
                alert('⚠️ Por favor, selecione um arquivo.');
                return;
            }
            
            iniciarAnalise(ano, disciplina, escola, precisao, selectedFile);
        }
        
        // Analysis functions
        async function iniciarAnalise(ano, disciplina, escola, precisao, file) {
            console.log('🔍 Iniciando análise:', { ano, disciplina, escola, precisao, file: file.name });
            
            mostrarLoading('Preparando análise...', 'Carregando arquivo');
            atualizarProgresso(10);
            
            try {
                // Read file content
                const conteudo = await lerArquivo(file);
                atualizarProgresso(30);
                
                // Extract questions
                mostrarLoading('Extraindo questões...', 'Identificando estrutura da prova');
                const questoes = extrairQuestoes(conteudo);
                atualizarProgresso(50);
                
                // Perform correlation analysis
                mostrarLoading('Analisando correlações...', `${questoes.length} questões encontradas`);
                const resultados = analisarCorrelacoes(questoes, ano, disciplina, parseInt(precisao));
                atualizarProgresso(80);
                
                // Show results
                mostrarLoading('Finalizando...', 'Preparando resultados');
                atualizarProgresso(100);
                
                setTimeout(() => {
                    esconderLoading();
                    mostrarResultados(resultados, ano, disciplina, escola);
                }, 500);
                
            } catch (error) {
                console.error('❌ Erro na análise:', error);
                esconderLoading();
                alert(`Erro na análise: ${error.message}`);
            }
        }
        
        // File reading function
        function lerArquivo(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                
                reader.onerror = function() {
                    reject(new Error('Erro ao ler o arquivo'));
                };
                
                // Read as text
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // Question extraction function
        function extrairQuestoes(conteudo) {
            const questoes = [];
            
            // Simple pattern matching for questions
            // Look for patterns like "1)", "1.", "Questão 1", etc.
            const patterns = [
                /(?:^|\n)\s*(\d+)\)\s*(.+?)(?=\n\s*\d+\)|$)/gs,
                /(?:^|\n)\s*(\d+)\.\s*(.+?)(?=\n\s*\d+\.|$)/gs,
                /(?:^|\n)\s*(?:Questão|QUESTÃO)\s*(\d+)(?:\s*[-.:)]|\s)\s*(.+?)(?=\n\s*(?:Questão|QUESTÃO)\s*\d+|$)/gs
            ];
            
            for (const pattern of patterns) {
                const matches = [...conteudo.matchAll(pattern)];
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const numero = parseInt(match[1]);
                        const texto = match[2].trim();
                        
                        if (texto.length > 20) { // Filter out very short matches
                            questoes.push({
                                numero: numero,
                                texto: texto,
                                palavrasChave: extrairPalavrasChave(texto)
                            });
                        }
                    });
                    break; // Use the first pattern that finds questions
                }
            }
            
            // If no pattern worked, try to split by paragraphs and guess
            if (questoes.length === 0) {
                const paragrafos = conteudo.split(/\n\s*\n/);
                let numero = 1;
                
                paragrafos.forEach(paragrafo => {
                    if (paragrafo.trim().length > 50) {
                        questoes.push({
                            numero: numero++,
                            texto: paragrafo.trim(),
                            palavrasChave: extrairPalavrasChave(paragrafo)
                        });
                    }
                });
            }
            
            console.log(`📝 ${questoes.length} questões extraídas`);
            return questoes;
        }
        
        // Extract keywords from question text
        function extrairPalavrasChave(texto) {
            // Remove common words and extract meaningful keywords
            const stopWords = new Set([
                'o', 'a', 'os', 'as', 'um', 'uma', 'uns', 'umas', 'de', 'da', 'do', 'das', 'dos',
                'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com', 'sem', 'sob', 'sobre',
                'que', 'qual', 'quais', 'como', 'quando', 'onde', 'por que', 'porque',
                'e', 'ou', 'mas', 'se', 'então', 'assim', 'também', 'já', 'ainda',
                'é', 'são', 'foi', 'foram', 'ser', 'estar', 'ter', 'haver',
                'este', 'esta', 'estes', 'estas', 'esse', 'essa', 'esses', 'essas',
                'aquele', 'aquela', 'aqueles', 'aquelas', 'isso', 'isto', 'aquilo'
            ]);
            
            const palavras = texto.toLowerCase()
                .replace(/[^\w\sáéíóúàèìòùâêîôûãõç]/g, ' ')
                .split(/\s+/)
                .filter(palavra => palavra.length > 3 && !stopWords.has(palavra));
            
            return [...new Set(palavras)].slice(0, 10); // Top 10 unique keywords
        }
        
        // Correlation analysis function using real matrix data
        function analisarCorrelacoes(questoes, ano, disciplina, precisaoMinima) {
            console.log('🧠 Analisando correlações com matriz real...');
            console.log(`📖 Disciplina: ${disciplina}, Ano: ${ano}, Precisão mínima: ${precisaoMinima}%`);
            
            const correlacoes = [];
            let totalCorrelacoes = 0;
            
            questoes.forEach((questao, index) => {
                atualizarProgresso(60 + (index / questoes.length) * 20);
                
                // Usar função de correlação da matriz real
                const correlacoesQuestao = correlacionarQuestao(
                    questao.texto, 
                    disciplina, 
                    ano, 
                    precisaoMinima
                );
                
                if (correlacoesQuestao.length > 0) {
                    // Pegar a melhor correlação para esta questão
                    const melhorCorrelacao = correlacoesQuestao[0];
                    
                    correlacoes.push({
                        questao: questao.numero,
                        texto: questao.texto.substring(0, 150) + '...',
                        habilidade: {
                            codigo: melhorCorrelacao.codigo,
                            descricao: melhorCorrelacao.habilidade,
                            bncc: melhorCorrelacao.bncc || 'N/A'
                        },
                        precisao: melhorCorrelacao.precisao,
                        palavrasChave: melhorCorrelacao.palavras_correspondentes,
                        metodo: 'matriz-referencia'
                    });
                    
                    totalCorrelacoes++;
                }
            });
            
            const precisaoMedia = correlacoes.length > 0 ? 
                correlacoes.reduce((sum, c) => sum + c.precisao, 0) / correlacoes.length : 0;
            
            const habilidadesUnicas = new Set(correlacoes.map(c => c.habilidade.codigo)).size;
            
            console.log(`✅ Análise concluída: ${correlacoes.length} correlações encontradas`);
            
            return {
                totalQuestoes: questoes.length,
                correlacoes: correlacoes,
                precisaoMedia: precisaoMedia,
                habilidadesCobertas: habilidadesUnicas,
                estatisticas: {
                    correlacionadas: correlacoes.length,
                    naoCorrelacionadas: questoes.length - correlacoes.length,
                    cobertura: Math.round((correlacoes.length / questoes.length) * 100)
                }
            };
        }
        
        // Results display
        function mostrarResultados(resultados, ano, disciplina, escola) {
            // Update stats
            document.getElementById('totalQuestoes').textContent = resultados.totalQuestoes;
            document.getElementById('correlacionesEncontradas').textContent = resultados.correlacoes.length;
            document.getElementById('mediaCorrelacao').textContent = resultados.precisaoMedia.toFixed(1) + '%';
            document.getElementById('habilidadesCobertas').textContent = resultados.habilidadesCobertas;
            
            // Update table
            const tbody = document.getElementById('correlationsTable');
            tbody.innerHTML = '';
            
            resultados.correlacoes.forEach(correlacao => {
                const precisaoClass = correlacao.precisao >= 80 ? 'correlation-high' :
                                    correlacao.precisao >= 60 ? 'correlation-medium' : 'correlation-low';
                
                const row = `
                    <tr>
                        <td><strong>Q${correlacao.questao}</strong></td>
                        <td><code>${correlacao.habilidade.codigo}</code></td>
                        <td>
                            ${correlacao.habilidade.descricao}
                            <div class="habilidade-details">${correlacao.texto}</div>
                        </td>
                        <td><span class="badge bg-primary">${correlacao.habilidade.bncc}</span></td>
                        <td>
                            <span class="correlation-badge ${precisaoClass}">${correlacao.precisao}%</span>
                        </td>
                        <td>
                            ${correlacao.palavrasChave.map(p => `<span class="keyword-match">${p}</span>`).join(' ')}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            console.log('📊 Resultados exibidos:', resultados);
        }
        
        // Utility functions
        function mostrarLoading(titulo, mensagem) {
            document.getElementById('loadingTitle').textContent = titulo;
            document.getElementById('loadingMessage').textContent = mensagem;
            document.getElementById('loadingOverlay').style.display = 'block';
        }
        
        function esconderLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function atualizarProgresso(porcentagem) {
            document.getElementById('progressBar').style.width = porcentagem + '%';
        }
        
        // Test and demo functions
        function testeRapido() {
            document.getElementById('anoEscolar').value = '6';
            document.getElementById('disciplina').value = 'portugues_leitura';
            document.getElementById('escola').value = 'Escola Teste';
            
            // Create fake file content
            const conteudoTeste = `
1) Leia o texto abaixo e responda:

O texto trata principalmente sobre meio ambiente e sustentabilidade...

2) Com base no texto, podemos inferir que:

a) A questão ambiental é importante
b) Devemos preservar a natureza
c) O texto defende o desenvolvimento sustentável

3) A palavra "sustentabilidade" no texto significa:

Desenvolvimento que atende às necessidades presentes sem comprometer o futuro.
            `;
            
            const arquivo = new File([conteudoTeste], 'teste.txt', { type: 'text/plain' });
            selectedFile = arquivo;
            showFilePreview(arquivo);
            
            alert('📝 Teste configurado! Clique em "Analisar Correlações" para continuar.');
        }
        
        function mostrarDemo() {
            alert(`📖 Como usar o SADE Matrizes v0.3.0:

1️⃣ Selecione o ano escolar e disciplina
2️⃣ Configure a precisão mínima desejada
3️⃣ Faça upload do arquivo da prova (TXT, DOC, PDF)
4️⃣ Clique em "Analisar Correlações"
5️⃣ Aguarde o processamento
6️⃣ Veja os resultados com correlações e precisão

🔍 O sistema usa análise inteligente baseada em:
• Palavras-chave do conteúdo
• Contexto das questões
• Matriz de Referência completa
• Códigos BNCC atualizados

✨ Use "Teste Rápido" para ver um exemplo!`);
        }
        
        function verificarMatriz() {
            if (typeof matrizReferencia === 'undefined') {
                alert('❌ Matriz de Referência não carregada! Verifique se o arquivo matriz-referencia-dados.js está presente.');
                return;
            }
            
            let info = '📊 INFORMAÇÕES DA MATRIZ DE REFERÊNCIA\n\n';
            info += `Total de habilidades: ${estatisticasMatriz.total}\n\n`;
            info += '📚 Por disciplina:\n';
            
            Object.entries(estatisticasMatriz.porDisciplina).forEach(([disc, total]) => {
                const disciplinaNome = {
                    'portugues_leitura': 'Português - Leitura',
                    'portugues_escrita': 'Português - Escrita', 
                    'matematica': 'Matemática',
                    'ciencias': 'Ciências da Natureza'
                }[disc] || disc;
                
                info += `• ${disciplinaNome}: ${total} habilidades\n`;
            });
            
            info += '\n🎓 Por ano (Português - Leitura):\n';
            Object.entries(matrizReferencia.portugues_leitura).forEach(([ano, habilidades]) => {
                info += `• ${ano}º ano: ${habilidades.length} habilidades\n`;
            });
            
            alert(info);
        }
        
        function exportarResultados() {
            if (!analysisResults) {
                alert('Nenhum resultado para exportar.');
                return;
            }
            
            alert('🚧 Funcionalidade de exportação será implementada em breve!');
        }
        
        function mostrarDetalhes() {
            if (!analysisResults) {
                alert('Nenhum resultado para mostrar detalhes.');
                return;
            }
            
            alert('🚧 Visualização detalhada será implementada em breve!');
        }
    </script>
</body>
</html>
